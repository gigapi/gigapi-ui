<!DOCTYPE html>
<html>
<head>
    <title>Test Hash Query Utils</title>
</head>
<body>
    <h1>Test Hash Query Utils</h1>
    <div id="output"></div>
    
    <script>
        // Test the exact same logic
        function testDecode() {
            const hash = window.location.hash.slice(1);
            console.log('Hash:', hash);
            
            if (!hash) {
                document.getElementById('output').innerHTML = 'No hash found';
                return;
            }
            
            try {
                // Handle both formats: query=<base64> and <base64>
                let cleanHash = hash.trim();
                
                // Check if hash starts with "query="
                if (cleanHash.startsWith('query=')) {
                    cleanHash = cleanHash.substring(6); // Remove "query=" prefix
                    console.log('Removed query= prefix, cleanHash:', cleanHash);
                }
                
                // Handle URL encoding
                if (cleanHash.includes('%')) {
                    cleanHash = decodeURIComponent(cleanHash);
                    console.log('After decodeURIComponent:', cleanHash);
                }
                
                // Add padding if needed for base64
                while (cleanHash.length % 4) {
                    cleanHash += '=';
                }
                
                // Replace any URL-safe base64 characters
                cleanHash = cleanHash.replace(/-/g, '+').replace(/_/g, '/');
                
                console.log('Clean hash:', cleanHash);
                
                const decoded = atob(cleanHash);
                console.log('Decoded:', decoded);
                
                const parsed = JSON.parse(decoded);
                console.log('Parsed:', parsed);
                
                document.getElementById('output').innerHTML = '<pre>' + JSON.stringify(parsed, null, 2) + '</pre>';
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('output').innerHTML = 'Error: ' + error.message;
            }
        }
        
        // Test on load
        testDecode();
        
        // Test when hash changes
        window.addEventListener('hashchange', testDecode);
    </script>
</body>
</html>
